#include <LiquidCrystal.h>
LiquidCrystal lcd(12, 11, 4, 5, 6, 7);

// Added new variables for Power Factor calculation
float Amp, Voltres, Voltin;
float instAmps, instVolts;
float sumP, sumV_sq, sumI_sq;
float RealPower, ApparentPower, PF;

void setup() {
  lcd.begin(16, 2);
  lcd.setCursor(0,0);
  lcd.print("Volt-Amper");
  delay(2000);
  lcd.clear();
}

void loop() {
  // Reset accumulators for the new cycle
  sumP = 0;
  sumV_sq = 0;
  sumI_sq = 0;

  // *SAMPLING LOOP* // We take 100 samples to capture the AC waveform behavior
  for (int i = 0; i < 100; i++) {
    int ADC0 = analogRead(A0);
    int ADC1 = analogRead(A1);

    // Calculate Instantaneous Current (using your original formula)
    // Amp = (ADC0 * 4.88mV) / 0.5 Ohms
    instAmps = (ADC0 * 4.88) / 0.5;

    // Calculate Instantaneous Voltage (using your original formula)
    instVolts = ADC1 * 4.88 * 0.00601;

    // Accumulate sums for RMS and Power calculation
    sumV_sq += instVolts * instVolts;      // Sum of Volts squared
    sumI_sq += instAmps * instAmps;        // Sum of Amps squared
    sumP    += instVolts * instAmps;       // Sum of Instantaneous Power (V*I)
    
    delay(1); // Small delay to spread samples over time
  }

  // *CALCULATIONS*
  // 1. Calculate RMS values (Root Mean Square)
  Voltin = sqrt(sumV_sq / 100.0);
  Amp    = sqrt(sumI_sq / 100.0);
  
  // 2. Calculate Powers
  RealPower = sumP / 100.0;             // Average of instantaneous power
  ApparentPower = Voltin * Amp;         // V_rms * I_rms

  // 3. Calculate Power Factor
  if (ApparentPower > 0) {
    PF = RealPower / ApparentPower;
  } else {
    PF = 0;
  }

  // Threshold logic from original code
  if(Amp <= 1) Amp = 0;
  
  // *DISPLAY*
  // Row 0: Voltage and Current (Original Display)
  lcd.setCursor(0,0);
  lcd.print("A:");
  lcd.print((int)Amp);
  lcd.print("mA ");
  
  lcd.setCursor(9,0);
  lcd.print("V:");
  lcd.print(Voltin, 1); // displaying with 1 decimal for clarity
  lcd.print("V");

  // Row 1: Power Factor (New Display)
  lcd.setCursor(0,1);
  lcd.print("PF:");
  lcd.print(PF); 
  
  delay(3000);  
}
